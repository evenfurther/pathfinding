language: rust

branches:
  only:
    - staging
    - trying

matrix:
  include:
    - rust: stable
      env: CHECK_UPDATE=y
    - rust: beta
    - rust: nightly
    - rust: nightly
      env: CHECK_CLIPPY=y CHECK_FMT=y
  allow_failures:
    - rust: nightly
      env: CHECK_CLIPPY=y CHECK_FMT=y
  fast_finish: true

cache:
  cargo: true

install:
  - if [ ! -z "$CHECK_FMT" ]; then (cargo install --force rustfmt-nightly | true); fi
  - if [ ! -z "$CHECK_CLIPPY" ]; then (cargo install --force clippy | true); fi

before_script:
  - if [ ! -z "$CHECK_FMT" ]; then PATH=$PATH:~/.cargo/bin cargo fmt -- --write-mode=diff; fi
  - if [ ! -z "$CHECK_CLIPPY" ]; then PATH=$PATH:~/.cargo/bin cargo clippy -- -D clippy; fi
  - if [ ! -z "$CHECK_UPDATE" ]; then PATH=$PATH:~/.cargo/bin cargo update -q && git diff --exit-code ; fi

script:
  - cargo build --verbose --all
  - cargo test --verbose --all
